// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// Core & Multi-tenancy
model Company {
  id                String   @id @default(uuid())
  name              String
  rif               String   @unique // Venezuelan Tax ID
  fiscal_year_start DateTime
  currency          String   @default("VES") // VES or USD
  created_at        DateTime @default(now())
  updated_at        DateTime @updatedAt

  // Relations
  accounts       ChartOfAccount[]
  journalEntries JournalEntry[]
  thirdParties   ThirdParty[]
  products       Product[]
  bankAccounts   BankAccount[]
  taxes          Tax[]
  documents      Document[]
}

// Accounting Module
enum AccountType {
  ASSET
  LIABILITY
  EQUITY
  INCOME
  COST
  EXPENSE
  OTHER
}

model ChartOfAccount {
  id         String      @id @default(uuid())
  company_id String
  company    Company     @relation(fields: [company_id], references: [id])
  code       String // Hierarchical: 1.1.01
  name       String
  type       AccountType
  parent_id  String?
  parent     ChartOfAccount? @relation("AccountHierarchy", fields: [parent_id], references: [id])
  children   ChartOfAccount[] @relation("AccountHierarchy")
  balance    Decimal     @default(0.00) @db.Decimal(20, 2)
  created_at DateTime    @default(now())
  updated_at DateTime    @updatedAt

  // Relations
  journalLines    JournalLine[]
  linkedProducts  Product[]     @relation("InventoryAsset")
  linkedCOGS      Product[]     @relation("COGS")
  linkedIncome    Product[]     @relation("SalesIncome")
  linkedBankAccts BankAccount[]
  
  // ThirdParty Relations
  linkedReceivables ThirdParty[] @relation("ThirdPartyReceivable")
  linkedPayables    ThirdParty[] @relation("ThirdPartyPayable")
  taxes             Tax[]

  @@unique([company_id, code])
}

enum JournalStatus {
  DRAFT
  POSTED
  VOID
}

model JournalEntry {
  id          String        @id @default(uuid())
  company_id  String
  company     Company       @relation(fields: [company_id], references: [id])
  date        DateTime
  description String
  status      JournalStatus @default(DRAFT)
  created_at  DateTime      @default(now())
  updated_at  DateTime      @updatedAt

  // Relations
  lines            JournalLine[]
  bankTransaction  BankTransaction?
  document         Document?
}

model JournalLine {
  id          String         @id @default(uuid())
  entry_id    String
  entry       JournalEntry   @relation(fields: [entry_id], references: [id])
  account_id  String
  account     ChartOfAccount @relation(fields: [account_id], references: [id])
  debit       Decimal        @default(0.00) @db.Decimal(20, 2)
  credit      Decimal        @default(0.00) @db.Decimal(20, 2)
  description String?
}

// Administrative Module
enum ThirdPartyType {
  CLIENTE
  PROVEEDOR
  AMBOS
}

model ThirdParty {
  id                   String   @id @default(uuid())
  company_id           String
  company              Company  @relation(fields: [company_id], references: [id])
  name                 String
  rif                  String
  email                String?
  phone                String?
  address              String?
  type                 ThirdPartyType @default(CLIENTE)
  
  is_tax_payer_special Boolean  @default(false)
  retention_agent_islr Boolean  @default(false)
  
  // Accounting Links
  receivable_account_id String?
  receivable_account    ChartOfAccount? @relation("ThirdPartyReceivable", fields: [receivable_account_id], references: [id])
  
  payable_account_id    String?
  payable_account       ChartOfAccount? @relation("ThirdPartyPayable", fields: [payable_account_id], references: [id])
  
  documents             Document[]

  created_at           DateTime @default(now())
  updated_at           DateTime @updatedAt
}

// Product model removed (merged below)

enum BankAccountType {
  CORRIENTE
  AHORRO
  CAJA_CHICA
  OTRO
}

model BankAccount {
  id             String         @id @default(uuid())
  company_id     String
  company        Company        @relation(fields: [company_id], references: [id])
  bank_name      String
  account_number String
  currency       String         @default("VES") // VES or USD
  type           BankAccountType @default(CORRIENTE)
  balance        Decimal        @default(0.00) @db.Decimal(20, 2)
  
  gl_account_id  String
  gl_account     ChartOfAccount @relation(fields: [gl_account_id], references: [id])
  created_at     DateTime       @default(now())
  updated_at     DateTime       @updatedAt

  // Relations
  transactions   BankTransaction[]
}

enum BankTransactionType {
  DEBIT
  CREDIT
}

enum BankTransactionStatus {
  PENDING
  RECONCILED
  VOID
}

model BankTransaction {
  id              String              @id @default(uuid())
  bank_account_id String
  bank_account    BankAccount         @relation(fields: [bank_account_id], references: [id])
  
  date            DateTime
  reference       String?
  description     String
  amount          Decimal             @db.Decimal(20, 2)
  type            BankTransactionType
  status          BankTransactionStatus @default(PENDING)
  
  // Venezuelan specifics
  is_igtf_applied Boolean             @default(false)
  igtf_amount     Decimal             @default(0.00) @db.Decimal(20, 2)
  
  // Atomic Link to Accounting
  journal_entry_id String?            @unique
  journal_entry    JournalEntry?      @relation(fields: [journal_entry_id], references: [id])

  created_at      DateTime            @default(now())
  updated_at      DateTime            @updatedAt
}

// Configuration Module
enum TaxType {
  IVA
  ISLR
  IGTF
  RETENCION_IVA
  RETENCION_ISLR
  OTRO
}

model Tax {
  id              String   @id @default(uuid())
  company_id      String
  company         Company  @relation(fields: [company_id], references: [id])
  name            String
  code            String?  
  rate            Decimal  @db.Decimal(5, 2) 
  type            TaxType
  description     String?

  // Connection to Accounting
  gl_account_id   String
  gl_account      ChartOfAccount @relation(fields: [gl_account_id], references: [id])

  is_active       Boolean  @default(true)
  created_at      DateTime @default(now())
  updated_at      DateTime @updatedAt
}

// Optimization: Single table for all document headers (Invoices, Bills, Credit Notes)
enum DocumentType {
  INVOICE        // Factura de Venta
  BILL           // Factura de Compra
  CREDIT_NOTE    // Nota de Credito
  DEBIT_NOTE     // Nota de Debito
  RECEIPT        // Recibo de Pago
  PAYMENT        // Comprobante de Egreso
}

enum PaymentStatus {
  PENDING
  PARTIAL
  PAID
  VOID
}

model Document {
  id              String         @id @default(uuid())
  company_id      String
  company         Company        @relation(fields: [company_id], references: [id])
  
  // Relations
  third_party_id  String
  third_party     ThirdParty     @relation(fields: [third_party_id], references: [id])
  currency_code   String
  
  // Document Info
  type            DocumentType
  date            DateTime
  due_date        DateTime?
  number          String         // Nro de Factura / Control
  reference       String?        // Order Reference, etc.
  
  // Financials
  subtotal        Decimal        @db.Decimal(15, 2)
  tax_amount      Decimal        @db.Decimal(15, 2)
  total           Decimal        @db.Decimal(15, 2)
  balance         Decimal        @db.Decimal(15, 2) // Remaining amount to be paid
  
  status          PaymentStatus  @default(PENDING)
  notes           String?

  // Items
  items           DocumentItem[]

  // Accounting Link
  journal_entry_id String?       @unique
  journal_entry   JournalEntry?  @relation(fields: [journal_entry_id], references: [id])

  created_at      DateTime       @default(now())
  updated_at      DateTime       @updatedAt

  @@unique([company_id, type, number])
  @@index([third_party_id])
  @@index([date])
}

model DocumentItem {
  id              String    @id @default(uuid())
  document_id     String
  document        Document  @relation(fields: [document_id], references: [id], onDelete: Cascade)

  // Product/Service Link
  product_id      String?
  product         Product?  @relation(fields: [product_id], references: [id])
  
  description     String
  quantity        Decimal   @db.Decimal(12, 4)
  unit_price      Decimal   @db.Decimal(15, 2)
  
  // Tax Info (Snapshot)
  tax_id          String?
  tax_rate        Decimal   @default(0) @db.Decimal(5, 2)
  tax_amount      Decimal   @default(0) @db.Decimal(15, 2)
  
  total           Decimal   @db.Decimal(15, 2)

  // Account Link (Sales/Expense Account)
  gl_account_id   String?   // Overrides product default if set
}

// INVENTORY MODULE

enum ProductType {
  GOODS
  SERVICE
}

model Product {
  id              String      @id @default(uuid())
  company_id      String
  company         Company     @relation(fields: [company_id], references: [id])
  
  name            String
  sku             String?
  description     String?
  type            ProductType
  
  // Tracking
  track_inventory Boolean     @default(false)
  quantity_on_hand Decimal    @default(0) @db.Decimal(12, 4)
  avg_cost        Decimal     @default(0) @db.Decimal(15, 2) // Costo Promedio Movil

  // Price
  sales_price     Decimal     @default(0) @db.Decimal(15, 2)
  
  // Accounting Links
  income_account_id String?
  income_account    ChartOfAccount? @relation("SalesIncome", fields: [income_account_id], references: [id])
  
  cogs_account_id   String?
  cogs_account      ChartOfAccount? @relation("COGS", fields: [cogs_account_id], references: [id])
  
  asset_account_id  String?
  asset_account     ChartOfAccount? @relation("InventoryAsset", fields: [asset_account_id], references: [id])

  // Tax Default
  tax_id          String?
  
  is_active       Boolean     @default(true)
  created_at      DateTime    @default(now())
  updated_at      DateTime    @updatedAt
  
  document_items  DocumentItem[]

  @@unique([company_id, sku])
}
